<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnglishBuddy - Tu Compa√±ero de Ingl√©s con IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        'primary-dark': '#2563EB',
                        secondary: '#10B981',
                        accent: '#F59E0B'
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 text-gray-900 dark:text-gray-100">
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                                üó£Ô∏è EnglishBuddy
                            </h1>
                        </div>
                        <div class="hidden md:block">
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                Tu compa√±ero de ingl√©s personalizado con IA
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Session Status -->
                        <div class="flex items-center space-x-2">
                            <div id="sessionIndicator" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                            <span id="sessionStatus" class="text-sm text-gray-600 dark:text-gray-400">Sesi√≥n pausada</span>
                        </div>
                        <button id="settingsBtn" class="p-2 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- API Key Alert (if not configured) -->
        <div id="apiKeyAlert" class="bg-yellow-50 dark:bg-yellow-900/20 border-b border-yellow-200 dark:border-yellow-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <svg class="h-5 w-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-sm text-yellow-800 dark:text-yellow-200">Necesitas configurar tu API Key de Google Gemini para empezar</span>
                    </div>
                    <button id="configureApiBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md text-sm transition-colors">
                        Configurar Ahora
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
                <!-- Left Sidebar - Controls & Stats -->
                <div class="lg:col-span-1 space-y-4">
                    <!-- Session Controls -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üéÆ Control de Sesi√≥n</h3>
                        <div class="space-y-3">
                            <button id="sessionBtn" class="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                                Empezar
                            </button>
                            <button id="endBtn" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 6h12v12H6z"/>
                                </svg>
                                Finalizar
                            </button>
                            <button id="resetBtn" class="w-full px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Reiniciar Todo
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üìä Estad√≠sticas de Hoy</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Conversaciones:</span>
                                <span id="todayConversations" class="font-medium">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Lecciones:</span>
                                <span id="todayLessons" class="font-medium">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Palabras nuevas:</span>
                                <span id="todayWords" class="font-medium">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Tiempo activo:</span>
                                <span id="activeTime" class="font-medium">0 min</span>
                            </div>
                        </div>
                    </div>

                    <!-- Voice Controls -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üé§ Control de Voz</h3>
                        <div class="space-y-3">
                            <button id="voiceBtn" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                </svg>
                                Hablar
                            </button>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="autoListen" class="rounded">
                                <label for="autoListen" class="text-sm">Escucha autom√°tica</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="enableTTS" class="rounded" checked>
                                <label for="enableTTS" class="text-sm">S√≠ntesis de voz</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Center - Main Chat -->
                <div class="lg:col-span-2">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg h-full flex flex-col">
                        <!-- Chat Header -->
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <span class="text-white font-bold">EB</span>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold">EnglishBuddy</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400" id="buddyStatus">Esperando que inicies la sesi√≥n</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-96">
                            <div class="flex justify-center">
                                <div class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-4 py-2 rounded-lg text-sm max-w-md text-center">
                                    ¬°Hola! Soy tu EnglishBuddy. Presiona "Empezar" cuando est√©s listo para conversar y aprender ingl√©s juntos. üòä
                                </div>
                            </div>
                        </div>

                        <!-- Lesson Panel (Hidden by default) -->
                        <div id="lessonPanel" class="border-t border-gray-200 dark:border-gray-700 p-4 bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 hidden">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-green-800 dark:text-green-300">üìö Lecci√≥n del d√≠a</h4>
                                <button id="startLessonBtn" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm transition-colors">
                                    Comenzar
                                </button>
                            </div>
                            <div id="lessonContent" class="text-sm text-gray-700 dark:text-gray-300">
                                <!-- Lesson content will be populated here -->
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex space-x-3">
                                <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." 
                                       class="flex-1 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 dark:text-white disabled:bg-gray-100 disabled:cursor-not-allowed dark:disabled:bg-gray-600" disabled>
                                <button id="sendBtn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Instructions & Tools -->
                <div class="lg:col-span-1 space-y-4">
                    <!-- Progress Indicator -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                        <h3 class="font-semibold mb-3">üìà Tu Progreso</h3>
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
                                <span id="levelIcon" class="text-white text-xl font-bold">üå±</span>
                            </div>
                            <p id="levelText" class="font-medium">Principiante</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">¬°Empecemos tu aventura!</p>
                        </div>
                    </div>

                    <!-- Custom Instructions -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="font-semibold flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253z"></path>
                                </svg>
                                Instrucciones
                            </h3>
                        </div>
                        <div class="p-4">
                            <textarea id="customInstructions" rows="4" placeholder="Dale instrucciones espec√≠ficas a tu EnglishBuddy..."
                                      class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white resize-none"></textarea>
                            <button id="applyInstructionsBtn" class="w-full mt-3 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                Aplicar Instrucciones
                            </button>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                        <h3 class="font-semibold mb-3">‚ö° Acciones R√°pidas</h3>
                        <div class="space-y-2">
                            <button class="quick-action w-full px-3 py-2 text-left text-sm bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed dark:disabled:bg-gray-600" data-action="correct" disabled>
                                ‚úÖ Corregir √∫ltimo error
                            </button>
                            <button class="quick-action w-full px-3 py-2 text-left text-sm bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed dark:disabled:bg-gray-600" data-action="repeat" disabled>
                                üîÑ Repetir ejercicio
                            </button>
                            <button class="quick-action w-full px-3 py-2 text-left text-sm bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed dark:disabled:bg-gray-600" data-action="example" disabled>
                                üí° M√°s ejemplos
                            </button>
                            <button class="quick-action w-full px-3 py-2 text-left text-sm bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed dark:disabled:bg-gray-600" data-action="challenge" disabled>
                                üéØ Nuevo reto
                            </button>
                            <button class="quick-action w-full px-3 py-2 text-left text-sm bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors disabled:bg-gray-100 disabled:cursor-not-allowed dark:disabled:bg-gray-600" data-action="skip" disabled>
                                ‚è≠Ô∏è Omitir y continuar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">‚öôÔ∏è Configuraci√≥n</h3>
                    <button id="closeSettingsBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- API Key -->
                    <div>
                        <label class="block text-sm font-medium mb-2">API Key de Google Gemini *</label>
                        <div class="space-y-2">
                            <div class="flex space-x-2">
                                <input type="password" id="apiKeyInput" placeholder="Ingresa tu API Key" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                                <button id="toggleApiKeyBtn" class="px-3 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md">
                                    üëÅÔ∏è
                                </button>
                            </div>
                            <div class="flex space-x-2">
                                <button id="saveApiKeyBtn" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md text-sm transition-colors">
                                    Guardar
                                </button>
                                <button id="removeApiKeyBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md text-sm transition-colors hidden">
                                    Eliminar
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                Obt√©n tu API Key en <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a>
                            </p>
                        </div>
                    </div>

                    <!-- Learning Level -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Nivel inicial (se ajustar√° autom√°ticamente)</label>
                        <select id="levelSelect" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                            <option value="beginner">Principiante</option>
                            <option value="elementary">Elemental</option>
                            <option value="intermediate">Intermedio</option>
                            <option value="upper-intermediate">Intermedio Superior</option>
                            <option value="advanced">Avanzado</option>
                        </select>
                    </div>

                    <!-- Reset Data -->
                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="resetDataBtn" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md text-sm transition-colors">
                            üóëÔ∏è Resetear Todos los Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Correction Modal -->
        <div id="correctionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full mx-4 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-red-600 dark:text-red-400">‚ùå Correcci√≥n</h3>
                    <button id="closeCorrectionBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="correctionContent" class="space-y-4">
                    <!-- Correction content will be populated here -->
                </div>

                <div class="flex space-x-3 mt-6">
                    <button id="tryCorrectionBtn" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors">
                        Intentar de nuevo
                    </button>
                    <button id="skipCorrectionBtn" class="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors">
                        Omitir y continuar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Application State
        class EnglishBuddyApp {
            constructor() {
                this.geminiModel = null;
                this.conversationHistory = [];
                this.userProfile = {
                    name: '',
                    interests: [],
                    level: 'beginner',
                    learningGoals: [],
                    commonErrors: [],
                    strongPoints: []
                };
                this.sessionData = {
                    conversationsToday: 0,
                    lessonsToday: 0,
                    wordsToday: 0,
                    isActive: false,
                    isPaused: true,
                    isInLesson: false,
                    currentLessonTopic: '',
                    awaitingCorrection: false,
                    startTime: null,
                    totalActiveTime: 0
                };
                this.settings = {
                    enableTTS: true,
                    enableSTT: true,
                    autoListen: false
                };
                
                this.speech = {
                    recognition: null,
                    synthesis: window.speechSynthesis,
                    isListening: false
                };

                this.timeInterval = null;
                this.initializeApp();
            }

            async initializeApp() {
                this.loadUserData();
                this.initializeElements();
                this.initializeSpeech();
                this.bindEvents();
                
                const savedApiKey = localStorage.getItem('englishbuddy_api_key');
                if (savedApiKey) {
                    await this.initializeGemini(savedApiKey);
                    document.getElementById('apiKeyInput').value = savedApiKey;
                    document.getElementById('removeApiKeyBtn').classList.remove('hidden');
                    document.getElementById('apiKeyAlert').classList.add('hidden');
                } else {
                    this.showApiKeyAlert();
                }
                
                this.updateUI();
            }

            loadUserData() {
                const savedProfile = localStorage.getItem('englishbuddy_profile');
                const savedSession = localStorage.getItem('englishbuddy_session');
                const savedSettings = localStorage.getItem('englishbuddy_settings');
                const savedHistory = localStorage.getItem('englishbuddy_history');

                if (savedProfile) {
                    this.userProfile = { ...this.userProfile, ...JSON.parse(savedProfile) };
                }
                
                if (savedSession) {
                    this.sessionData = { ...this.sessionData, ...JSON.parse(savedSession) };
                    // Reset session state on app load
                    this.sessionData.isActive = false;
                    this.sessionData.isPaused = true;
                }
                
                if (savedSettings) {
                    this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                }

                if (savedHistory) {
                    this.conversationHistory = JSON.parse(savedHistory);
                }
            }

            saveUserData() {
                localStorage.setItem('englishbuddy_profile', JSON.stringify(this.userProfile));
                localStorage.setItem('englishbuddy_session', JSON.stringify(this.sessionData));
                localStorage.setItem('englishbuddy_settings', JSON.stringify(this.settings));
                localStorage.setItem('englishbuddy_history', JSON.stringify(this.conversationHistory));
            }

            initializeElements() {
                this.elements = {
                    // Main elements
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    
                    // Session controls
                    sessionBtn: document.getElementById('sessionBtn'),
                    endBtn: document.getElementById('endBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    sessionIndicator: document.getElementById('sessionIndicator'),
                    sessionStatus: document.getElementById('sessionStatus'),
                    
                    // API Key alert
                    apiKeyAlert: document.getElementById('apiKeyAlert'),
                    configureApiBtn: document.getElementById('configureApiBtn'),
                    
                    // Settings
                    settingsBtn: document.getElementById('settingsBtn'),
                    settingsModal: document.getElementById('settingsModal'),
                    closeSettingsBtn: document.getElementById('closeSettingsBtn'),
                    apiKeyInput: document.getElementById('apiKeyInput'),
                    toggleApiKeyBtn: document.getElementById('toggleApiKeyBtn'),
                    saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
                    removeApiKeyBtn: document.getElementById('removeApiKeyBtn'),
                    levelSelect: document.getElementById('levelSelect'),
                    enableTTS: document.getElementById('enableTTS'),
                    resetDataBtn: document.getElementById('resetDataBtn'),
                    
                    // Lesson elements
                    lessonPanel: document.getElementById('lessonPanel'),
                    startLessonBtn: document.getElementById('startLessonBtn'),
                    lessonContent: document.getElementById('lessonContent'),
                    
                    // Instructions
                    customInstructions: document.getElementById('customInstructions'),
                    applyInstructionsBtn: document.getElementById('applyInstructionsBtn'),
                    
                    // Stats
                    todayConversations: document.getElementById('todayConversations'),
                    todayLessons: document.getElementById('todayLessons'),
                    todayWords: document.getElementById('todayWords'),
                    activeTime: document.getElementById('activeTime'),
                    levelText: document.getElementById('levelText'),
                    levelIcon: document.getElementById('levelIcon'),
                    buddyStatus: document.getElementById('buddyStatus'),
                    
                    // Correction modal
                    correctionModal: document.getElementById('correctionModal'),
                    closeCorrectionBtn: document.getElementById('closeCorrectionBtn'),
                    correctionContent: document.getElementById('correctionContent'),
                    tryCorrectionBtn: document.getElementById('tryCorrectionBtn'),
                    skipCorrectionBtn: document.getElementById('skipCorrectionBtn'),
                    
                    // Quick actions
                    quickActions: document.querySelectorAll('.quick-action'),
                    
                    // Other
                    autoListen: document.getElementById('autoListen')
                };

                // Set initial values
                this.elements.levelSelect.value = this.userProfile.level;
                this.elements.enableTTS.checked = this.settings.enableTTS;
                this.elements.autoListen.checked = this.settings.autoListen;
            }

            initializeSpeech() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.speech.recognition = new SpeechRecognition();
                    this.speech.recognition.continuous = false;
                    this.speech.recognition.interimResults = false;
                    this.speech.recognition.lang = 'es-ES';

                    this.speech.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.elements.messageInput.value = transcript;
                        this.sendMessage();
                    };

                    this.speech.recognition.onend = () => {
                        this.speech.isListening = false;
                        this.updateVoiceButton();
                    };

                    this.speech.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.speech.isListening = false;
                        this.updateVoiceButton();
                    };
                }
            }

            bindEvents() {
                // Message sending
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                // Voice control
                this.elements.voiceBtn.addEventListener('click', () => this.toggleVoice());

                // Session controls
                this.elements.sessionBtn.addEventListener('click', () => this.toggleSession());
                this.elements.endBtn.addEventListener('click', () => this.endSession());
                this.elements.resetBtn.addEventListener('click', () => this.resetSession());

                // API Key
                this.elements.configureApiBtn.addEventListener('click', () => this.showSettings());

                // Settings
                this.elements.settingsBtn.addEventListener('click', () => this.showSettings());
                this.elements.closeSettingsBtn.addEventListener('click', () => this.hideSettings());
                this.elements.toggleApiKeyBtn.addEventListener('click', () => this.toggleApiKeyVisibility());
                this.elements.saveApiKeyBtn.addEventListener('click', () => this.saveApiKey());
                this.elements.removeApiKeyBtn.addEventListener('click', () => this.removeApiKey());
                this.elements.resetDataBtn.addEventListener('click', () => this.resetAllData());

                // Level change
                this.elements.levelSelect.addEventListener('change', (e) => {
                    this.userProfile.level = e.target.value;
                    this.saveUserData();
                    this.updateUI();
                });

                // Settings checkboxes
                this.elements.enableTTS.addEventListener('change', (e) => {
                    this.settings.enableTTS = e.target.checked;
                    this.saveUserData();
                });

                this.elements.autoListen.addEventListener('change', (e) => {
                    this.settings.autoListen = e.target.checked;
                    this.saveUserData();
                });

                // Custom instructions
                this.elements.applyInstructionsBtn.addEventListener('click', () => this.applyCustomInstructions());

                // Lesson controls
                this.elements.startLessonBtn.addEventListener('click', () => this.startLesson());

                // Quick actions
                this.elements.quickActions.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        this.handleQuickAction(action);
                    });
                });

                // Correction modal
                this.elements.closeCorrectionBtn.addEventListener('click', () => this.hideCorrectionModal());
                this.elements.tryCorrectionBtn.addEventListener('click', () => this.retryCorrection());
                this.elements.skipCorrectionBtn.addEventListener('click', () => this.skipCorrection());

                // Click outside modal to close
                window.addEventListener('click', (e) => {
                    if (e.target === this.elements.settingsModal) {
                        this.hideSettings();
                    }
                    if (e.target === this.elements.correctionModal) {
                        this.hideCorrectionModal();
                    }
                });
            }

            async initializeGemini(apiKey) {
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    this.geminiModel = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
                    this.updateSessionButton();
                    return true;
                } catch (error) {
                    console.error("Error initializing Gemini:", error);
                    throw new Error("API Key inv√°lida o error de inicializaci√≥n");
                }
            }

            buildSystemPrompt() {
                return `Eres EnglishBuddy, un asistente de IA revolucionario para aprender ingl√©s. Tu personalidad es amigable, paciente y motivadora.

PERFIL DEL USUARIO:
- Nivel: ${this.userProfile.level}
- Intereses: ${this.userProfile.interests.join(', ') || 'Por descubrir'}
- Errores comunes: ${this.userProfile.commonErrors.join(', ') || 'Ninguno registrado'}

INSTRUCCIONES PRINCIPALES:

1. FASE DE CONVERSACI√ìN (Espa√±ol):
   - Habla SIEMPRE en espa√±ol durante esta fase
   - Conoce al usuario: sus intereses, trabajo, hobbies, d√≠a a d√≠a
   - Haz preguntas espec√≠ficas sobre sus temas de inter√©s
   - S√© natural, como un amigo curioso
   - Despu√©s de 3-5 intercambios, sugiere una lecci√≥n del d√≠a

2. FASE DE LECCI√ìN (Ingl√©s + Espa√±ol):
   - Basa las lecciones en los intereses del usuario
   - Progresi√≥n: palabra ‚Üí frase corta ‚Üí oraci√≥n ‚Üí conversaci√≥n
   - Siempre explica en espa√±ol primero, luego ense√±a en ingl√©s
   - Da ejemplos relacionados con sus intereses
   - Eval√∫a respuestas: correcto/incorrecto con explicaci√≥n

3. SISTEMA DE CORRECCI√ìN:
   - Si est√° mal: explica el error en espa√±ol, da la forma correcta
   - Ofrece ejemplos adicionales
   - Pregunta si quiere intentar de nuevo o continuar
   - Registra errores para futuras lecciones

4. PERSONALIZACI√ìN:
   - Adapta vocabulario a sus intereses
   - Usa ejemplos de sus temas favoritos
   - Ajusta dificultad seg√∫n el nivel
   - Recuerda errores previos para reforzar

5. MOTIVACI√ìN:
   - Celebra logros
   - Da feedback positivo
   - Ofrece retos progresivos
   - Mant√©n un tono amigable y alentador

Responde de manera natural y siempre recuerda que eres como un amigo que ayuda a aprender ingl√©s.`;
            }

            toggleSession() {
                if (!this.geminiModel) {
                    this.showError('Por favor configura tu API Key primero');
                    return;
                }

                if (!this.sessionData.isActive) {
                    this.startSession();
                } else if (this.sessionData.isPaused) {
                    this.resumeSession();
                } else {
                    this.pauseSession();
                }
            }

            async startSession() {
                this.sessionData.isActive = true;
                this.sessionData.isPaused = false;
                this.sessionData.startTime = new Date();
                
                // Initialize conversation if empty
                if (this.conversationHistory.length === 0) {
                    await this.initializeConversation();
                }
                
                this.startTimeTracking();
                this.enableInterface();
                this.updateSessionButton();
                this.updateSessionStatus();
                this.saveUserData();
                
                this.updateBuddyStatus('¬°Listo para conversar!');
            }

            pauseSession() {
                this.sessionData.isPaused = true;
                this.stopTimeTracking();
                this.disableInterface();
                this.updateSessionButton();
                this.updateSessionStatus();
                this.updateBuddyStatus('Sesi√≥n pausada');
                this.saveUserData();
            }

            resumeSession() {
                this.sessionData.isPaused = false;
                this.sessionData.startTime = new Date();
                this.startTimeTracking();
                this.enableInterface();
                this.updateSessionButton();
                this.updateSessionStatus();
                this.updateBuddyStatus('¬°Continuemos!');
                this.saveUserData();
            }

            endSession() {
                this.sessionData.isActive = false;
                this.sessionData.isPaused = true;
                this.stopTimeTracking();
                this.disableInterface();
                this.updateSessionButton();
                this.updateSessionStatus();
                this.updateBuddyStatus('Sesi√≥n finalizada');
                
                this.addMessage('system', 'üëã Sesi√≥n finalizada. ¬°Excelente trabajo hoy!');
                this.saveUserData();
            }

            resetSession() {
                this.showConfirmDialog('¬øSeguro que quieres reiniciar todo? Se perder√° el progreso actual.', () => {
                    this.conversationHistory = [];
                    this.sessionData = {
                        conversationsToday: 0,
                        lessonsToday: 0,
                        wordsToday: 0,
                        isActive: false,
                        isPaused: true,
                        isInLesson: false,
                        currentLessonTopic: '',
                        awaitingCorrection: false,
                        startTime: null,
                        totalActiveTime: 0
                    };
                    this.elements.chatMessages.innerHTML = `
                        <div class="flex justify-center">
                            <div class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-4 py-2 rounded-lg text-sm max-w-md text-center">
                                ¬°Hola! Soy tu EnglishBuddy. Presiona "Empezar" cuando est√©s listo para conversar y aprender ingl√©s juntos. üòä
                            </div>
                        </div>
                    `;
                    this.stopTimeTracking();
                    this.disableInterface();
                    this.updateUI();
                    this.saveUserData();
                });
            }

            updateSessionButton() {
                if (!this.geminiModel) {
                    this.elements.sessionBtn.textContent = 'Empezar';
                    this.elements.sessionBtn.disabled = true;
                    this.elements.sessionBtn.className = 'w-full px-4 py-3 bg-gray-400 text-white rounded-lg font-medium cursor-not-allowed';
                    return;
                }

                if (!this.sessionData.isActive) {
                    this.elements.sessionBtn.textContent = 'Empezar';
                    this.elements.sessionBtn.disabled = false;
                    this.elements.sessionBtn.className = 'w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors font-medium';
                } else if (this.sessionData.isPaused) {
                    this.elements.sessionBtn.textContent = 'Continuar';
                    this.elements.sessionBtn.disabled = false;
                    this.elements.sessionBtn.className = 'w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium';
                } else {
                    this.elements.sessionBtn.textContent = 'Pausar';
                    this.elements.sessionBtn.disabled = false;
                    this.elements.sessionBtn.className = 'w-full px-4 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors font-medium';
                }
            }

            updateSessionStatus() {
                const indicator = this.elements.sessionIndicator;
                const status = this.elements.sessionStatus;

                if (!this.sessionData.isActive) {
                    indicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    status.textContent = 'Sesi√≥n pausada';
                    this.elements.endBtn.disabled = true;
                } else if (this.sessionData.isPaused) {
                    indicator.className = 'w-3 h-3 bg-yellow-400 rounded-full';
                    status.textContent = 'En pausa';
                    this.elements.endBtn.disabled = false;
                } else {
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
                    status.textContent = 'Sesi√≥n activa';
                    this.elements.endBtn.disabled = false;
                }
            }

            enableInterface() {
                this.elements.messageInput.disabled = false;
                this.elements.sendBtn.disabled = false;
                this.elements.voiceBtn.disabled = false;
                this.elements.applyInstructionsBtn.disabled = false;
                
                this.elements.quickActions.forEach(btn => {
                    btn.disabled = false;
                });
                
                this.elements.messageInput.placeholder = 'Escribe tu mensaje...';
            }

            disableInterface() {
                this.elements.messageInput.disabled = true;
                this.elements.sendBtn.disabled = true;
                this.elements.voiceBtn.disabled = true;
                this.elements.applyInstructionsBtn.disabled = true;
                
                this.elements.quickActions.forEach(btn => {
                    btn.disabled = true;
                });
                
                this.elements.messageInput.placeholder = 'Inicia la sesi√≥n para conversar...';
            }

            startTimeTracking() {
                this.timeInterval = setInterval(() => {
                    this.sessionData.totalActiveTime += 1; // minutes
                    this.updateUI();
                }, 60000); // Update every minute
            }

            stopTimeTracking() {
                if (this.timeInterval) {
                    clearInterval(this.timeInterval);
                    this.timeInterval = null;
                }
            }

            async initializeConversation() {
                const systemPrompt = this.buildSystemPrompt();
                this.conversationHistory = [
                    { role: 'system', content: systemPrompt }
                ];
                
                const initialMessage = '¬°Hola! Soy tu EnglishBuddy. Cu√©ntame sobre ti: ¬øa qu√© te dedicas? ¬øcu√°les son tus intereses? ¬øqu√© te gusta hacer en tu tiempo libre? ¬°Empecemos a conocernos! üòä';
                
                this.addMessage('assistant', initialMessage);
                this.conversationHistory.push({ role: 'assistant', content: initialMessage });
                
                // Speak the welcome message
                if (this.settings.enableTTS) {
                    this.speakText(initialMessage);
                }
                
                this.saveUserData();
            }

            async sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (!message || !this.geminiModel || this.sessionData.isPaused) return;

                this.addMessage('user', message);
                this.elements.messageInput.value = '';
                this.updateBuddyStatus('Pensando...');

                try {
                    // Add user message to history
                    this.conversationHistory.push({ role: 'user', content: message });

                    // Build conversation context
                    const conversationText = this.conversationHistory
                        .filter(msg => msg.role !== 'system')
                        .map(msg => `${msg.role === 'user' ? 'Usuario' : 'EnglishBuddy'}: ${msg.content}`)
                        .join('\n\n');

                    const fullPrompt = `${this.conversationHistory[0].content}

HISTORIAL DE CONVERSACI√ìN:
${conversationText}

INSTRUCCIONES ESPECIALES:
${this.elements.customInstructions.value || 'Ninguna instrucci√≥n especial.'}

DATOS DE LA SESI√ìN:
- Conversaciones hoy: ${this.sessionData.conversationsToday}
- Lecciones hoy: ${this.sessionData.lessonsToday}
- En lecci√≥n: ${this.sessionData.isInLesson ? 'S√≠' : 'No'}
- Tema actual: ${this.sessionData.currentLessonTopic || 'Ninguno'}

Responde como EnglishBuddy de manera natural y √∫til.`;

                    const result = await this.geminiModel.generateContent(fullPrompt);
                    const response = await result.response;
                    const text = await response.text();

                    this.addMessage('assistant', text);
                    this.conversationHistory.push({ role: 'assistant', content: text });

                    // Process response for lesson detection and user profiling
                    this.processResponse(text, message);

                    // Text-to-speech if enabled
                    if (this.settings.enableTTS) {
                        this.speakText(text);
                    }

                    // Auto-listen if enabled
                    if (this.settings.autoListen) {
                        setTimeout(() => this.startVoiceRecognition(), 1000);
                    }

                    this.updateBuddyStatus('¬°Listo para conversar!');
                    this.sessionData.conversationsToday++;
                    this.saveUserData();
                    this.updateUI();

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.addMessage('system', 'Error al procesar el mensaje. Por favor, verifica tu conexi√≥n.');
                    this.updateBuddyStatus('Error - Reinicia la conversaci√≥n');
                }
            }

            processResponse(response, userMessage) {
                // Check for lesson suggestion
                if (response.toLowerCase().includes('lecci√≥n del d√≠a') || response.toLowerCase().includes('lesson')) {
                    this.showLessonPanel(response);
                }

                // Extract user interests
                const interestKeywords = ['me gusta', 'interesa', 'trabajo en', 'estudio', 'hobby', 'afici√≥n'];
                if (interestKeywords.some(keyword => userMessage.toLowerCase().includes(keyword))) {
                    this.extractInterests(userMessage);
                }

                // Check for correction context
                if (response.toLowerCase().includes('incorrecto') || response.toLowerCase().includes('error')) {
                    this.sessionData.awaitingCorrection = true;
                    this.showCorrectionModal(response);
                }

                // Update lesson status
                if (response.toLowerCase().includes('comenzamos') || response.toLowerCase().includes('empecemos')) {
                    this.sessionData.isInLesson = true;
                    this.sessionData.lessonsToday++;
                }
            }

            extractInterests(message) {
                const words = message.toLowerCase().split(' ');
                const potentialInterests = [];

                // Simple keyword extraction
                const topicKeywords = {
                    'tecnolog√≠a': ['programaci√≥n', 'c√≥digo', 'software', 'computadora', 'tecnolog√≠a'],
                    'm√∫sica': ['m√∫sica', 'cantar', 'tocar', 'instrumento', 'banda'],
                    'deportes': ['f√∫tbol', 'basketball', 'correr', 'gym', 'ejercicio'],
                    'comida': ['cocinar', 'cocina', 'recetas', 'restaurante', 'comida'],
                    'viajes': ['viajar', 'turismo', 'pa√≠ses', 'culturas', 'aventura']
                };

                Object.entries(topicKeywords).forEach(([topic, keywords]) => {
                    if (keywords.some(keyword => words.includes(keyword))) {
                        if (!this.userProfile.interests.includes(topic)) {
                            this.userProfile.interests.push(topic);
                            potentialInterests.push(topic);
                        }
                    }
                });

                if (potentialInterests.length > 0) {
                    this.saveUserData();
                }
            }

            addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                    role === 'user' 
                        ? 'bg-blue-500 text-white' 
                        : role === 'assistant'
                        ? 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100'
                        : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'
                }`;

                // Process markdown if it's an assistant message
                if (role === 'assistant' && window.marked && window.DOMPurify) {
                    bubbleDiv.innerHTML = window.DOMPurify.sanitize(window.marked.parse(content));
                } else {
                    bubbleDiv.textContent = content;
                }

                messageDiv.appendChild(bubbleDiv);
                this.elements.chatMessages.appendChild(messageDiv);
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }

            showLessonPanel(content) {
                if (window.marked && window.DOMPurify) {
                    this.elements.lessonContent.innerHTML = window.DOMPurify.sanitize(window.marked.parse(content));
                } else {
                    this.elements.lessonContent.textContent = content;
                }
                this.elements.lessonPanel.classList.remove('hidden');
            }

            startLesson() {
                this.sessionData.isInLesson = true;
                this.elements.lessonPanel.classList.add('hidden');
                this.addMessage('system', 'üìö ¬°Lecci√≥n iniciada! Sigue las instrucciones de tu EnglishBuddy.');
                this.saveUserData();
            }

            showCorrectionModal(content) {
                if (window.marked && window.DOMPurify) {
                    this.elements.correctionContent.innerHTML = window.DOMPurify.sanitize(window.marked.parse(content));
                } else {
                    this.elements.correctionContent.textContent = content;
                }
                this.elements.correctionModal.classList.remove('hidden');
            }

            hideCorrectionModal() {
                this.elements.correctionModal.classList.add('hidden');
                this.sessionData.awaitingCorrection = false;
            }

            retryCorrection() {
                this.hideCorrectionModal();
                this.addMessage('system', 'üîÑ Intenta de nuevo. Tu EnglishBuddy te est√° esperando.');
            }

            skipCorrection() {
                this.hideCorrectionModal();
                this.addMessage('system', '‚è≠Ô∏è Continuando con la lecci√≥n...');
                this.elements.messageInput.value = 'Contin√∫a con la siguiente parte de la lecci√≥n';
                this.sendMessage();
            }

            handleQuickAction(action) {
                const actions = {
                    'correct': '‚úÖ Por favor, corrige mi √∫ltimo error y expl√≠came qu√© hice mal.',
                    'repeat': 'üîÑ Repite el √∫ltimo ejercicio con un ejemplo diferente.',
                    'example': 'üí° Dame m√°s ejemplos del tema actual.',
                    'challenge': 'üéØ Dame un reto m√°s dif√≠cil relacionado con este tema.',
                    'skip': '‚è≠Ô∏è Omite esto y contin√∫a con la siguiente parte.'
                };

                if (actions[action]) {
                    this.elements.messageInput.value = actions[action];
                    this.sendMessage();
                }
            }

            toggleVoice() {
                if (!this.speech.recognition) {
                    this.addMessage('system', 'Reconocimiento de voz no disponible en este navegador.');
                    return;
                }

                if (this.speech.isListening) {
                    this.speech.recognition.stop();
                } else {
                    this.startVoiceRecognition();
                }
            }

            startVoiceRecognition() {
                if (!this.speech.recognition) return;

                this.speech.isListening = true;
                this.updateVoiceButton();
                this.speech.recognition.start();
                this.updateBuddyStatus('Escuchando...');
            }

            updateVoiceButton() {
                const isListening = this.speech.isListening;
                this.elements.voiceBtn.innerHTML = isListening 
                    ? `<svg class="w-4 h-4 mr-2 animate-pulse" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/></svg>Escuchando...`
                    : `<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>Hablar`;
                
                this.elements.voiceBtn.className = isListening 
                    ? 'w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors flex items-center justify-center'
                    : 'w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors flex items-center justify-center';
            }

            speakText(text) {
                if (!this.settings.enableTTS || !this.speech.synthesis) return;

                // Cancel any ongoing speech
                this.speech.synthesis.cancel();

                // Clean text for speech
                const cleanText = text
                    .replace(/[*_`#]/g, '')
                    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                    .replace(/\n/g, ' ');

                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                
                this.speech.synthesis.speak(utterance);
            }

            applyCustomInstructions() {
                const instructions = this.elements.customInstructions.value.trim();
                if (!instructions) return;

                this.addMessage('system', `üìù Instrucciones aplicadas: ${instructions}`);
                this.elements.customInstructions.value = '';
            }

            showConfirmDialog(message, onConfirm) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                        <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Cancelar</button>
                            <button class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded" onclick="this.closest('.fixed').remove(); (${onConfirm.toString()})()">Confirmar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            showApiKeyAlert() {
                this.elements.apiKeyAlert.classList.remove('hidden');
            }

            toggleApiKeyVisibility() {
                const input = this.elements.apiKeyInput;
                const btn = this.elements.toggleApiKeyBtn;
                
                if (input.type === 'password') {
                    input.type = 'text';
                    btn.textContent = 'üôà';
                } else {
                    input.type = 'password';
                    btn.textContent = 'üëÅÔ∏è';
                }
            }

            async saveApiKey() {
                const apiKey = this.elements.apiKeyInput.value.trim();
                if (!apiKey) {
                    this.showError('Por favor ingresa una API Key v√°lida.');
                    return;
                }

                try {
                    await this.initializeGemini(apiKey);
                    localStorage.setItem('englishbuddy_api_key', apiKey);
                    this.elements.removeApiKeyBtn.classList.remove('hidden');
                    this.elements.apiKeyAlert.classList.add('hidden');
                    this.hideSettings();
                    this.addMessage('system', '‚úÖ API Key guardada correctamente. ¬°Listo para conversar!');
                } catch (error) {
                    this.showError('Error: API Key inv√°lida. Por favor verifica tu clave.');
                }
            }

            removeApiKey() {
                this.showConfirmDialog('¬øSeguro que quieres eliminar la API Key?', () => {
                    localStorage.removeItem('englishbuddy_api_key');
                    this.elements.apiKeyInput.value = '';
                    this.elements.removeApiKeyBtn.classList.add('hidden');
                    this.geminiModel = null;
                    this.showApiKeyAlert();
                    this.endSession();
                    this.updateSessionButton();
                });
            }

            resetAllData() {
                this.showConfirmDialog('¬øSeguro que quieres eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.', () => {
                    localStorage.removeItem('englishbuddy_profile');
                    localStorage.removeItem('englishbuddy_session');
                    localStorage.removeItem('englishbuddy_settings');
                    localStorage.removeItem('englishbuddy_history');
                    localStorage.removeItem('englishbuddy_api_key');
                    location.reload();
                });
            }

            showSettings() {
                this.elements.settingsModal.classList.remove('hidden');
            }

            hideSettings() {
                this.elements.settingsModal.classList.add('hidden');
            }

            updateBuddyStatus(status) {
                this.elements.buddyStatus.textContent = status;
            }

            showError(message) {
                this.addMessage('system', `‚ùå ${message}`);
            }

            updateUI() {
                // Update stats
                this.elements.todayConversations.textContent = this.sessionData.conversationsToday;
                this.elements.todayLessons.textContent = this.sessionData.lessonsToday;
                this.elements.todayWords.textContent = this.sessionData.wordsToday;
                this.elements.activeTime.textContent = `${this.sessionData.totalActiveTime} min`;

                // Update level
                const levels = {
                    'beginner': { text: 'Principiante', icon: 'üå±' },
                    'elementary': { text: 'Elemental', icon: 'üåø' },
                    'intermediate': { text: 'Intermedio', icon: 'üå≥' },
                    'upper-intermediate': { text: 'Intermedio Superior', icon: 'üéØ' },
                    'advanced': { text: 'Avanzado', icon: 'üèÜ' }
                };

                const levelInfo = levels[this.userProfile.level] || levels['beginner'];
                this.elements.levelText.textContent = levelInfo.text;
                this.elements.levelIcon.textContent = levelInfo.icon;

                this.updateSessionStatus();
            }
        }

        // Initialize the application
        window.app = new EnglishBuddyApp();

    </script>
</body>
</html>